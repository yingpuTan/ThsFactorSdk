 cmake_minimum_required(VERSION 3.10)
project(ThsFactorSdkSync)

# 设置C++标准
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 设置输出目录
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# 包含目录
include_directories(include)

# 定义导出宏
add_definitions(-DCOSMOS_THSFACTOR_SDK_DLL_EXPORT)

# 库目录
link_directories(lib)

# 查找LHSession.dll
find_file(LHSESSION_DLL LHSession.dll PATHS lib dll NO_DEFAULT_PATH)
if(NOT LHSESSION_DLL)
    message(WARNING "未找到LHSession.dll，请确保dll目录中存在该文件")
endif()

# 编译同步接口示例程序
add_executable(demo_sync
    demo/main_sync.cpp
)

# 设置运行时库路径，确保能找到LHSession.dll
if(WIN32)
    # 明确指定 LHSession.lib 的绝对路径，避免找不到库
    target_link_libraries(demo_sync PRIVATE "${CMAKE_SOURCE_DIR}/lib/LHSession.lib")
endif()

# Windows特定设置
if(WIN32)
    # 复制LHSession.dll到输出目录
    if(LHSESSION_DLL)
        add_custom_command(TARGET demo_sync POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            ${LHSESSION_DLL}
            $<TARGET_FILE_DIR:demo_sync>
        )
    endif()
    
    # 复制其他依赖DLL
    file(GLOB DLL_FILES "dll/*.dll")
    foreach(DLL_FILE ${DLL_FILES})
        add_custom_command(TARGET demo_sync POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            ${DLL_FILE}
            $<TARGET_FILE_DIR:demo_sync>
        )
    endforeach()
endif()

